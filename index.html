<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TD Panel — Tracking Division</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  :root{
    --bg:#0b1220; --panel:#132033; --accent:#00d1c7; --accent-2:#5eead4; --text:#e6f1ff; --muted:#9fb3c8;
  }
  body{background:var(--bg); color:var(--text);}
  .navbar{background:linear-gradient(90deg,#0d1b2a,#0f2c3f)}
  .brand{color:var(--accent-2)}
  .card{background:var(--panel); border:none; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.35)}
  .table{color:var(--text)}
  .table thead{background:var(--accent); color:#002b29}
  .btn-primary{background:var(--accent); border:0} .btn-primary:hover{filter:brightness(0.9)}
  .btn-outline-light{border-color:#2b3c54; color:var(--text)}
  .badge-role{background:var(--accent); color:#033}
  a{color:var(--accent-2)}
  .form-text{color:var(--muted)!important}
  .pill{display:inline-block; padding:.25rem .6rem; border-radius:999px; background:#0d2a3f; color:#bfefff; font-size:.8rem}
</style>
</head>
<body>
<nav class="navbar px-3">
  <div class="d-flex align-items-center gap-2">
    <span class="brand fw-bold">📂 TD Panel</span>
  </div>
  <div class="d-flex align-items-center gap-2">
    <span id="whoami" class="pill d-none"></span>
    <button id="btnSettings" class="btn btn-outline-light btn-sm d-none" data-bs-toggle="modal" data-bs-target="#settingsModal">Ustawienia</button>
    <button id="btnAdmin" class="btn btn-outline-light btn-sm d-none" data-bs-toggle="modal" data-bs-target="#agentModal">➕ Dodaj agenta</button>
    <button id="btnLogin" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#authModal">Zaloguj</button>
    <button id="btnLogout" class="btn btn-danger btn-sm d-none">Wyloguj</button>
  </div>
</nav>

<div class="container my-4">
  <div id="alerts"></div>

  <div class="card p-3 mb-3">
    <div class="row g-2">
      <div class="col-md-4">
        <input id="search" class="form-control" placeholder="Szukaj (UID/Imię/Nazwisko/Ranga)">
      </div>
      <div class="col-md-4">
        <select id="rankFilter" class="form-select">
          <option value="">— filtruj po randze —</option>
        </select>
      </div>
      <div class="col-md-4 d-flex gap-2 justify-content-md-end">
        <button id="btnExportJSON" class="btn btn-outline-light btn-sm d-none">Eksport JSON</button>
        <button id="btnExportCSV" class="btn btn-outline-light btn-sm d-none">Eksport CSV</button>
      </div>
    </div>
  </div>

  <div class="card p-3">
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead><tr>
          <th>UID</th><th>Imię</th><th>Nazwisko</th><th>Ranga</th><th>Basic TD (zdane/łącznie)</th><th>Akcje</th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal: Logowanie/Rejestracja -->
<div class="modal fade" id="authModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Wejście do systemu</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <ul class="nav nav-tabs mb-3" role="tablist">
          <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabLogin" type="button">Logowanie</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabRegister" type="button">Rejestracja agenta</button></li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane fade show active" id="tabLogin">
            <div class="mb-2"><label class="form-label">UID</label><input id="loginUid" class="form-control" placeholder="np. TD-001"></div>
            <div class="mb-2"><label class="form-label">Hasło</label><input id="loginPass" type="password" class="form-control"></div>
            <div class="form-text">Admin loguje się mailem <code>admin@td.agency</code> (UID pole zostaw puste i wpisz e-mail w polu UID).</div>
          </div>
          <div class="tab-pane fade" id="tabRegister">
            <div class="mb-2"><label class="form-label">UID (musi istnieć w bazie)</label><input id="regUid" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Hasło</label><input id="regPass" type="password" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Powtórz hasło</label><input id="regPass2" type="password" class="form-control"></div>
            <div class="form-text">Podczas rejestracji tworzymy konto o adresie <code>UID@td.agency</code>.</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="doLogin" class="btn btn-primary">Zaloguj</button>
        <button id="doRegister" class="btn btn-outline-light">Zarejestruj</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Ustawienia (zmiana hasła) -->
<div class="modal fade" id="settingsModal" tabindex="-1">
  <div class="modal-dialog"><form class="modal-content" id="pwdForm">
    <div class="modal-header"><h5 class="modal-title">Zmiana hasła</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <div class="mb-2"><label class="form-label">Nowe hasło</label><input type="password" id="newPwd" class="form-control" required></div>
      <div class="mb-2"><label class="form-label">Powtórz nowe hasło</label><input type="password" id="newPwd2" class="form-control" required></div>
      <div class="form-text">Dotyczy aktualnie zalogowanego konta (np. admina). Hasło nie jest nigdzie ujawniane w kodzie.</div>
    </div>
    <div class="modal-footer"><button class="btn btn-primary" type="submit">Zmień</button></div>
  </form></div>
</div>

<!-- Modal: Dodaj/Edytuj Agenta (ADMIN) -->
<div class="modal fade" id="agentModal" tabindex="-1">
  <div class="modal-dialog"><form class="modal-content" id="agentForm">
    <div class="modal-header"><h5 class="modal-title" id="agentModalTitle">Dodaj agenta</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <input type="hidden" id="agentId">
      <div class="mb-2"><label class="form-label">UID</label><input id="fUid" class="form-control" required></div>
      <div class="mb-2"><label class="form-label">Imię</label><input id="fImie" class="form-control" required></div>
      <div class="mb-2"><label class="form-label">Nazwisko</label><input id="fNazwisko" class="form-control" required></div>
      <div class="mb-2"><label class="form-label">Ranga</label><input id="fRanga" class="form-control" required></div>
    </div>
    <div class="modal-footer"><button class="btn btn-primary" type="submit">Zapisz</button></div>
  </form></div>
</div>

<!-- Modal: Profil & Basic TD -->
<div class="modal fade" id="profileModal" tabindex="-1">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title" id="profileTitle">Profil</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body" id="profileBody"></div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button></div>
  </div></div>
</div>

<!-- Firebase (modular SDK) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updatePassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, doc, addDoc, getDocs, getDoc, setDoc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ===== TODO: Wklej TU swoją konfigurację Firebase =====
const firebaseConfig = {
  apiKey: "AIzaSyCwaURS_vQ-vDTwNnzTPRetKjofDese9L8",
  authDomain: "baza-danych-td.firebaseapp.com",
  projectId: "baza-danych-td",
  storageBucket: "baza-danych-td.firebasestorage.app",
  messagingSenderId: "1001512748132",
  appId: "1:1001512748132:web:d8bab00a6b02d9921a4b71",
  measurementId: "G-TPFQSGQ8Y6"
};

  // =====================================================

  // Init
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // UI helpers
  const $ = s => document.querySelector(s);
  const alertBox = (type, msg) => {
    const el = document.createElement('div');
    el.className = `alert alert-${type} alert-dismissible fade show`;
    el.innerHTML = `${msg}<button class="btn-close" data-bs-dismiss="alert"></button>`;
    $("#alerts").appendChild(el); setTimeout(()=>el.remove(), 6000);
  };
  const emailFromUID = (uid) => {
    if(uid.includes('@')) return uid; // pozwól adminowi wpisać swój mail
    return `${uid}@td.agency`.toLowerCase();
  }
  const isAdmin = () => auth.currentUser?.email === 'admin@td.agency';

  // ====== Render listy agentów ======
  async function loadAgents(){
    const qSnap = await getDocs(query(collection(db,'agents'), orderBy('uid')));
    const agents = qSnap.docs.map(d => ({id:d.id, ...d.data()}));
    renderAgents(agents);
  }
  function renderAgents(list){
    const q = ($("#search").value||'').toLowerCase();
    const rf = ($("#rankFilter").value||'').toLowerCase();

    const ranks = [...new Set(list.map(a=>a.ranga).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'pl'));
    $("#rankFilter").innerHTML = `<option value="">— filtruj po randze —</option>` + ranks.map(r=>`<option>${r}</option>`).join('');

    const filtered = list.filter(a=>{
      const hit = (`${a.uid} ${a.imie} ${a.nazwisko} ${a.ranga}`).toLowerCase().includes(q);
      return hit && (!rf || (a.ranga||'').toLowerCase()===rf);
    });

    const tbody = $("#tbody"); tbody.innerHTML='';
    filtered.forEach(a=>{
      const done = (a.basicTD||[]).filter(x=>!!x.passed).length;
      const total = (a.basicTD||[]).length;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="text-decoration-underline" style="cursor:pointer" data-act="profile">${a.uid}</td>
        <td>${a.imie||''}</td>
        <td>${a.nazwisko||''}</td>
        <td>${a.ranga||''}</td>
        <td>${done}/${total}</td>
        <td>
          <button class="btn btn-sm btn-info me-1 ${isAdmin()? '' : 'd-none'}" data-act="edit">✏️</button>
          <button class="btn btn-sm btn-danger ${isAdmin()? '' : 'd-none'}" data-act="del">🗑️</button>
        </td>
      `;
      tr.querySelector('[data-act="profile"]').onclick = ()=>openProfile(a);
      if(isAdmin()){
        tr.querySelector('[data-act="edit"]').onclick = ()=>openAgentModal(a);
        tr.querySelector('[data-act="del"]').onclick  = async ()=>{
          if(confirm('Usunąć agenta?')){ await deleteDoc(doc(db,'agents',a.id)); alertBox('success','Usunięto.'); loadAgents(); }
        };
      }
      tbody.appendChild(tr);
    });
  }

  // ====== Profil agenta & Basic TD ======
  async function openProfile(agent){
    const isSelf = agent.authUid && auth.currentUser && agent.authUid === auth.currentUser.uid;
    const canEdit = isAdmin() || isSelf; // admin lub sam agent może edytować Basic TD

    const rows = (agent.basicTD||[]).map((t,idx)=>`
      <tr>
        <td><input class="form-control form-control-sm" data-f="name" data-i="${idx}" value="${t.name||''}" ${isAdmin()? '' : 'disabled'}></td>
        <td><input type="date" class="form-control form-control-sm" data-f="date" data-i="${idx}" value="${t.date||''}" ${isAdmin()? '' : 'disabled'}></td>
        <td>
          <select class="form-select form-select-sm" data-f="passed" data-i="${idx}" ${canEdit? '' : 'disabled'}>
            <option value="true" ${t.passed?'selected':''}>Zdał</option>
            <option value="false" ${!t.passed?'selected':''}>Nie zdał</option>
          </select>
        </td>
        <td>
          <button class="btn btn-sm btn-danger ${isAdmin()? '' : 'd-none'}" data-del="${idx}">🗑️</button>
        </td>
      </tr>
    `).join('');

    $("#profileTitle").textContent = `${agent.imie} ${agent.nazwisko} — ${agent.ranga} (UID: ${agent.uid})`;
    $("#profileBody").innerHTML = `
      <div class="mb-3"><span class="pill">Dostęp: ${isAdmin()? 'Administracja' : isSelf? 'Agent (własny profil)' : 'Podgląd'}</span></div>
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-2">Basic TD</h5>
          <button class="btn btn-primary btn-sm ${isAdmin()? '' : 'd-none'}" id="addRow">➕ Dodaj pozycję</button>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead><tr><th>Nazwa</th><th>Data</th><th>Status</th><th>Akcje</th></tr></thead>
            <tbody id="tdBody">${rows}</tbody>
          </table>
        </div>
        <div class="text-end">
          <button class="btn btn-primary ${canEdit? '' : 'd-none'}" id="saveTD">Zapisz zmiany</button>
        </div>
      </div>
    `;

    const modal = bootstrap.Modal.getOrCreateInstance($("#profileModal")); modal.show();

    if(isAdmin()){
      $("#addRow").onclick = ()=>{
        agent.basicTD = agent.basicTD || [];
        agent.basicTD.push({name:'', date:'', passed:false});
        openProfile(agent);
      };
      $("#tdBody").querySelectorAll('[data-del]').forEach(btn=>{
        btn.onclick = ()=>{
          const i = +btn.getAttribute('data-del');
          agent.basicTD.splice(i,1); openProfile(agent);
        };
      });
      $("#tdBody").querySelectorAll('[data-f]').forEach(el=>{
        el.oninput = ()=>{
          const i = +el.getAttribute('data-i'); const f = el.getAttribute('data-f');
          agent.basicTD[i][f] = (f==='passed') ? (el.value==='true') : el.value;
        };
      });
    } else if(canEdit){
      $("#tdBody").querySelectorAll('[data-f="passed"]').forEach(el=>{
        el.onchange = ()=>{
          const i = +el.getAttribute('data-i'); agent.basicTD[i].passed = (el.value==='true');
        };
      });
    }

    const saveBtn = $("#saveTD");
    if(saveBtn){ saveBtn.onclick = async ()=>{
      await updateDoc(doc(db,'agents',agent.id), { basicTD: agent.basicTD||[] });
      alertBox('success','Zapisano Basic TD.'); loadAgents();
    }; }
  }

  // ====== Admin: Dodaj/Edytuj agenta ======
  function openAgentModal(agent=null){
    $("#agentForm").reset();
    $("#agentId").value = agent?.id || '';
    $("#fUid").value = agent?.uid || '';
    $("#fImie").value = agent?.imie || '';
    $("#fNazwisko").value = agent?.nazwisko || '';
    $("#fRanga").value = agent?.ranga || '';
    $("#agentModalTitle").textContent = agent ? 'Edytuj agenta' : 'Dodaj agenta';
    bootstrap.Modal.getOrCreateInstance($("#agentModal")).show();
  }
  $("#agentForm").onsubmit = async (e)=>{
    e.preventDefault();
    if(!isAdmin()) return alertBox('warning','Tylko administracja.');
    const id   = $("#agentId").value || null;
    const data = {
      uid: $("#fUid").value.trim(),
      imie: $("#fImie").value.trim(),
      nazwisko: $("#fNazwisko").value.trim(),
      ranga: $("#fRanga").value.trim(),
      basicTD: []
    };
    if(!data.uid || !data.imie || !data.nazwisko || !data.ranga){ alertBox('danger','Wypełnij wszystkie pola.'); return; }
    if(id){ await updateDoc(doc(db,'agents',id), data); alertBox('success','Zapisano zmiany.'); }
    else { await addDoc(collection(db,'agents'), data); alertBox('success','Dodano agenta.'); }
    bootstrap.Modal.getInstance($("#agentModal")).hide(); loadAgents();
  };

  // ====== Auth (logowanie/rejestracja) ======
  $("#doLogin").onclick = async ()=>{
    const uid = $("#loginUid").value.trim();
    const pass= $("#loginPass").value;
    if(!uid || !pass){ alertBox('danger','Wpisz UID/e-mail i hasło.'); return; }
    const email = emailFromUID(uid);
    try{
      await signInWithEmailAndPassword(auth, email, pass);
      bootstrap.Modal.getInstance($("#authModal"))?.hide();
    }catch(e){ alertBox('danger','Logowanie nieudane: '+e.message); }
  };
  $("#doRegister").onclick = async ()=>{
    const uid = $("#regUid").value.trim();
    const p1  = $("#regPass").value, p2 = $("#regPass2").value;
    if(!uid || !p1){ alertBox('danger','Wpisz UID i hasło.'); return; }
    if(p1!==p2){ alertBox('danger','Hasła się różnią.'); return; }
    // sprawdź, czy istnieje agent o danym UID
    const snap = await getDocs(collection(db,'agents'));
    const agent = snap.docs.map(d=>({id:d.id,...d.data()})).find(a=>a.uid.toLowerCase()===uid.toLowerCase());
    if(!agent){ alertBox('warning','Brak takiego UID w bazie. Najpierw dodaj go w panelu administracji.'); return; }
    try{
      const cred = await createUserWithEmailAndPassword(auth, emailFromUID(uid), p1);
      // zapisz mapowanie authUid ↔ dokument agenta
      await updateDoc(doc(db,'agents',agent.id), { authUid: cred.user.uid });
      alertBox('success','Konto utworzone. Jesteś zalogowany.');
      bootstrap.Modal.getInstance($("#authModal"))?.hide();
    }catch(e){ alertBox('danger','Rejestracja nieudana: '+e.message); }
  };

  // Zmiana hasła dla zalogowanego (np. admin)
  $("#pwdForm").onsubmit = async (e)=>{
    e.preventDefault();
    const p1=$("#newPwd").value, p2=$("#newPwd2").value;
    if(p1!==p2){ alertBox('danger','Hasła się różnią.'); return; }
    try{ await updatePassword(auth.currentUser, p1); alertBox('success','Hasło zmienione.'); bootstrap.Modal.getInstance($("#settingsModal")).hide(); }
    catch(e){ alertBox('danger','Błąd zmiany hasła: '+e.message); }
  };

  // ====== Eksport (admin) ======
  const download = (name, text, type='text/plain')=>{
    const blob = new Blob([text], {type}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };
  $("#btnExportJSON").onclick = async ()=>{
    const qSnap = await getDocs(collection(db,'agents'));
    const data = qSnap.docs.map(d=>({id:d.id,...d.data()}));
    download('agents.json', JSON.stringify(data,null,2),'application/json');
  };
  $("#btnExportCSV").onclick = async ()=>{
    const qSnap = await getDocs(collection(db,'agents'));
    const rows = [['UID','Imię','Nazwisko','Ranga','BasicTD (name|date|passed;...)']];
    qSnap.docs.forEach(d=>{
      const a=d.data(); const td=(a.basicTD||[]).map(t=>`${t.name||''}|${t.date||''}|${!!t.passed}`).join(';');
      rows.push([a.uid,a.imie,a.nazwisko,a.ranga,td]);
    });
    const csv = rows.map(r=>r.map(v=>{
      v=String(v??''); return /[",\n]/.test(v)?`"${v.replace(/"/g,'""')}"`:v;
    }).join(',')).join('\n');
    download('agents.csv', csv,'text/csv');
  };

  // ====== State: UI wg roli ======
  function applyRoleUI(){
    const u = auth.currentUser;
    $("#whoami").classList.toggle('d-none', !u);
    $("#btnLogout").classList.toggle('d-none', !u);
    $("#btnLogin").classList.toggle('d-none', !!u);
    $("#btnSettings").classList.toggle('d-none', !u);
    $("#btnAdmin").classList.toggle('d-none', !(u && isAdmin()));
    $("#btnExportJSON").classList.toggle('d-none', !(u && isAdmin()));
    $("#btnExportCSV").classList.toggle('d-none', !(u && isAdmin()));
    $("#whoami").textContent = u ? (isAdmin()? 'Administracja' : (u.email||'Użytkownik')) : '';
  }

  onAuthStateChanged(auth, async (user)=>{
    applyRoleUI();
    await loadAgents();
  });

  // ====== Inicjalizacja ======
  $("#search").oninput = ()=>loadAgents();
  $("#rankFilter").onchange = ()=>loadAgents();
  $("#btnLogout").onclick = ()=>auth.signOut();

  // Wskazówka dla pierwszego uruchomienia:
  alertBox('info','Zaloguj się jako admin: <code>admin@td.agency</code> + hasło ustawione w Firebase → dodaj agentów → agent może się zarejestrować używając swojego UID.');
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
